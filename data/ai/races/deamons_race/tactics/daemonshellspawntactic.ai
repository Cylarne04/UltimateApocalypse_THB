----------------------------------------
-- File: 'daemonshellspawntactic.ai'
-- Edited by Thudmeizer @ 10.06.2011
-- Edited by Cylarne_04 2011
-- Edited by CornCobMan 03/06/2013

class 'DaemonsHellSpawnTactic' (DaemonsInfantryTactic)

DaemonsHellSpawn = {}

function DaemonsHellSpawnTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("Daemons Hell Spawn Tactic")
end

function DaemonsHellSpawnTactic:InitAbilities()

	-- Init ability ID's
	if (DaemonsHellSpawn.doomblast_id == nil) then
		DaemonsHellSpawn.doomblast_id = cpu_manager.stats:GetAbilityID( "daemons_doom_blast" )	
	end
	
	--[[if (DaemonsHellSpawn.warp_portal_id == nil) then
		DaemonsHellSpawn.warp_portal_id = cpu_manager.stats:GetAbilityID( "daemons_warp_portal_hellspawn" )	
	end]]

	if (DaemonsHellSpawn.warpfire_id == nil) then
		DaemonsHellSpawn.warpfire_id = cpu_manager.stats:GetAbilityID( "daemons_warpfire" )	
	end	
end

function DaemonsHellSpawnTactic:DoAbilities()

	local iPower = resource_manager:GetResourceAmount():Get( ResourceAmount.RT_Power )

	if ( iPower >= 1000 ) then
		Ability.DoAbilityPos( self.squad_ai, DaemonsHellSpawn.doomblast_id, Ability.Filters.CloseSquadEnemy, 1 )
	end
	--Ability.DoAbilityPos( self.squad_ai, DaemonsHellSpawn.warp_portal_id, Ability.Filters.CloseSquadEnemy, 1 )
	
	Ability.DoAbilityTarget( self.squad_ai, DaemonsHellSpawn.warpfire_id, Ability.Filters.CloseEnemy, 3 )

	-- Try to spawn Horblus
	if (self.timedDirectSpawnAbility ~= nil) then
		self.timedDirectSpawnAbility:Call()
	else
		DaemonsHellSpawnTactic.DoDirectSpawnAbility(self)
	end
end

function DaemonsHellSpawnTactic:JumpAttackRanged()

	--[[ Call standard method
	if (Tactic.JumpAttackRanged(self)) then
		return true
	end
	
	-- Get position and jump range
	local vHellSpawnPosition = self.squad_ai:GetPosition()
	local iJumpRange = sqr(self.squad_ai:GetJumpDistance())
	
	-- Check if we can jump directly to the target
	local iClosestDistance = distance_sqr(vHellSpawnPosition, self.target)
	local vTargetPos = nil
	if (iClosestDistance < iJumpRange) then
		vTargetPos = self.target
	else
	
		-- Get closest squad to target position
		for oSquad in military_manager:GetSquads() do
	
			-- Check if squad is valid
			if (oSquad:IsValid()) then
			
				-- Check distance
				local vPosition = oSquad:GetPosition()
				local iDistanceToHellSpawn = distance_sqr(vPosition, vHellSpawnPosition)
				local iDistanceToTarget = distance_sqr(vPosition, self.target)
				if (iDistanceToHellSpawn < iJumpRange and iDistanceToTarget < iClosestDistance) then
					iClosestDistance = iDistanceToTarget
					vTargetPos = vPosition
				end
			end
		end
		
		-- Get closest building to target position
		for oBuilding in military_manager:GetBases() do
		
			-- Check if building is valid
			if (oBuilding:IsValid()) then
			
				-- Check distance
				local vPosition = oBuilding:GetPosition()
				local iDistanceToHellSpawn = distance_sqr(vPosition, vHellSpawnPosition)
				local iDistanceToTarget = distance_sqr(vPosition, self.target)
				if (iDistanceToHellSpawn < iJumpRange and iDistanceToTarget < iClosestDistance) then
					iClosestDistance = iDistanceToTarget
					vTargetPos = vPosition
				end
			end
		end
	end
	
	-- Don't jump if we didn't find a target
	if (vTargetPos == nil or distance_sqr(vHellSpawnPosition, vTargetPos) < sqr(50)) then
		return false
	end
	
	-- Try to jump to target
	for iLoop1 = 1, 5 do
	
		-- Create a jump position
		local vJumpPosition = vTargetPos
		vJumpPosition.x = vJumpPosition.x + math.random(-15, 15)
		vJumpPosition.z = vJumpPosition.z + math.random(-15, 15)
			
		-- Check if target position is in range and if unit is able to jump to target position
		local iDistance = distance_sqr(vJumpPosition, vHellSpawnPosition)
		if (iDistance <= iJumpRange and self.squad_ai:CanJumpToPosition(vJumpPosition)) then
							
			-- Jump to position
			self.squad_ai:DoJump(vJumpPosition)
			self.last_jump = g_iGMT
			self.m_iLastGatherMove = self.last_jump - 10
			return true
		end
	end
	return false]]
end

function DaemonsHellSpawnTactic:AlwaysAttack()
	return true
end

function DaemonsHellSpawnTactic:DoDirectSpawnAbility()

	-- Spawn Horblu Support in combat
	if (self.squad_ai:CanDirectSpawn()) then 
		self.squad_ai:DoDirectSpawn()
	end
end
